---

- hosts: lbs
  name: Setup load balancers
  remote_user: ci
  become: yes
  tasks:
    - name: Install haproxy
      apt:
        name:
          - haproxy
        state: present
        update_cache: yes

    - name: Create haproxy conf empty file
      copy:
        content: ""
        dest: /etc/haproxy/haproxy.cfg
        force: yes

    - name: Configure haproxy
      shell: |
        cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg
        frontend kube_apiserver_frontend
          bind *:6443
          mode tcp
          option tcplog
          default_backend kube_apiserver_backend

        backend kube_apiserver_backend
          option httpchk GET /healthz
          http-check expect status 200
          mode tcp
          option ssl-hello-chk
          balance roundrobin
            server k8s-master-1 172.16.1.11:6443 check fall 3 rise 2
            server k8s-master-2 172.16.1.12:6443 check fall 3 rise 2
            server k8s-master-3 172.16.1.13:6443 check fall 3 rise 2
        EOF

    - name: Restart haproxy
      systemd:
        name: haproxy
        state: restarted
        enabled: yes
        daemon-reload: yes

    - name: Install keepalived
      apt:
        name:
          - keepalived
        state: present
        update_cache: yes

    - name: Create check_apiserver.sh empty file
      copy:
        content: ""
        dest: /etc/keepalived/check_apiserver.sh
        force: no

    - name: Create check_apiserver.sh
      shell: |
        cat <<EOF | sudo tee /etc/keepalived/check_apiserver.sh
        #!/bin/sh

        curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || exit 1
        if ip addr | grep -q {{ cluster_vip }}; then
          curl --silent --max-time 2 --insecure https://{{ cluster_vip }}:6443/ -o /dev/null || exit 1
        fi
        EOF

    - name: Allow execute check_apiserver.sh
      shell: chmod +x /etc/keepalived/check_apiserver.sh

    - name: Create keepalived.conf empty file
      copy:
        content: ""
        dest: /etc/keepalived/keepalived.conf
        force: yes

    - name: Create keepalived.conf
      blockinfile:
        path: /etc/keepalived/keepalived.conf
        block: |
          vrrp_script check_apiserver {
            script "/etc/keepalived/check_apiserver.sh"
            interval 3
            timeout 10
          }

          vrrp_instance VI_1 {
              state MASTER
              interface ens2
              virtual_router_id 101
              priority 101
              authentication {
                  auth_type PASS
                  auth_pass secret
              }
              virtual_ipaddress {
                  {{ cluster_vip }}
              }
              track_script {
                  check_apiserver
              }
          }

    - name: Restart keepalived
      systemd:
        name: keepalived
        state: restarted
        enabled: yes
        daemon-reload: yes

